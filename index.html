<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name="generator" content=
    "HTML Tidy for HTML5 (experimental) for Mac OS X https://github.com/w3c/tidy-html5/tree/c63cc39">
    <title>
      Wake Lock API
    </title>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async
    class='remove'></script>
    <script class='remove'>
      /*stops tidy screwing things up*/
      var respecConfig = {
        specStatus: "ED",
        shortName: "wake-lock",
        editors: [{
          name: "Kenneth Rohde Christiansen",
          company: "Intel Corporation",
          companyURL: "https://intel.com/",
          w3cid: 57705
        }],
        formerEditors: [{
          name: "Ilya Bogdanovich",
          url: "mailto:bogdanovichiy@yandex-team.ru",
          company: "Yandex",
          w3cid: "71741"
        }, {
          name: "Andrey Logvinov",
          url: "mailto:alogvinov@yandex-team.ru",
          company: "Yandex",
          w3cid: "75989"
        }, {
          name: "Marcos Caceres",
          url: "mailto:marcos@marcosc.com",
          company: "Mozilla",
          w3cid: "39125"
        }],
        github: "https://github.com/w3c/wake-lock/",
        wg: "Device APIs Working Group",
        wgURI: "https://www.w3.org/2009/dap/",
        wgPublicList: "public-device-apis",
        wgPatentURI: "https://www.w3.org/2004/01/pp-impl/43696/status",
        testSuiteURI: "https://w3c-test.org/wake-lock/",
        implementationReportURI: "https://www.w3.org/2009/dap/wiki/ImplementationStatus",
        otherLinks: [{
          key: 'Quality Assurance Lead',
          data: [{
            value: 'Wanming Lin (Intel)',
            href: 'https://github.com/Honry'
          }]
        }, {
          key: 'Use cases',
          data: [{
            value: 'Use Cases and Requirements',
            href: 'https://w3c-webmob.github.io/wake-lock-use-cases/'
          }]
        }, {
          key: "Implementation status",
          data: [{
            value: "Blink",
            href: "https://bugs.chromium.org/p/chromium/issues/detail?id=257511"
          }]
        }],
        xref: true
      };
    </script>
  </head>
  <body data-cite="HTML WEBIDL DOM FEATURE-POLICY INFRA">
    <section id='abstract'>
      <p>
        This document specifies an API that allows web applications to request
        a wake lock. A wake lock prevents some aspect of the device from
        entering a power-saving state (e.g., preventing the system from turning
        off the screen).
      </p>
    </section>
    <section id='sotd'>
      <p>
        Implementors need to be aware that this specification is extremely
        unstable. <strong>Implementors who are not taking part in the
        discussions will find the specification changing out from under them in
        incompatible ways.</strong> Vendors interested in implementing this
        specification before it eventually reaches the Candidate Recommendation
        phase should <a href=
        "https://github.com/w3c/wake-lock/issues">subscribe to the repository
        on GitHub</a> and take part in the discussions.
      </p>
    </section>
    <section>
      <h2>
        Wake Locks
      </h2>
      <p>
        A <dfn>wake lock</dfn> prevents some aspect of the device or operating
        system from entering a power-saving state.
      </p>
      <p>
        This specification defines two <dfn data-lt="wake lock type">wake lock
        types</dfn>:
      </p>
      <ol>
        <li>
          <dfn>Screen wake lock</dfn> which prevents device's screen from
          turning off so that the user can still see the information displayed
          on the screen.
        </li>
        <li>
          <dfn>System wake lock</dfn> which prevents device's CPU from entering
          a standby mode so that the programs can continue running.
        </li>
      </ol>
      <div class="note">
        One type of wake lock can imply the effects of another: for example,
        screen wake lock logically implies that the program which displays
        information on the screen continues running, as if the system wake lock
        were also applied. But to avoid dependence on such implementation
        details which may not always be true, this specification treats all
        types of wake locks as independent.
      </div>
      <p>
        A <a>user agent</a> can <dfn>deny wake lock</dfn> of a particular
        <a data-lt="wake lock type">type</a> for a particular <a>Document</a>
        by any implementation-specific reason, for example, a user or platform
        setting or preference.
      </p>
    </section>
    <section data-cite="feature-policy"> <h3>Policy control</h3>
      <p data-tests=
      "wakelock-enabled-on-self-origin-by-feature-policy.https.sub.html, wakelock-enabled-by-feature-policy-attribute-redirect-on-load.https.sub.html, wakelock-enabled-by-feature-policy-attribute.https.sub.html, wakelock-enabled-by-feature-policy.https.sub.html">
        The <dfn>wake lock feature</dfn> is a <a>policy-controlled feature</a>
        with <a data-cite="feature-policy#feature-name">feature name</a>
        <code>"wake-lock"</code> and <a>default
        allowlist</a> <code>["self"]</code>.
      </p>
      <div class="note">
        <p>
          The <a>default allowlist</a> of <code>["self"]</code> allows wake
          lock usage in same-origin nested frames but prevents third-party
          content from using wake locks.
        </p>
        <p>
          Third-party usage can be selectively enabled by adding
          <code>allow="wake-lock"</code> attribute to the frame container
          element:
        </p>
        <pre class="example html">
          &lt;iframe src="https://third-party.com" allow="wake-lock"/&gt;&lt;/iframe&gt;
        </pre>
        <p>
          Alternatively, the wake lock feature can be disabled completely by
          specifying the feature policy in a HTTP response header:
        </p>
        <pre class="example">
          Feature-Policy: {"wake-lock": []}
        </pre>
        <p>
          See [[FEATURE-POLICY]] for more details.
        </p>
      </div>
    </section>
    <section> <h3>Permissions and user prompts</h3>
      <p>
        The [[PERMISSIONS]] API provides a uniform way for websites to request
        permissions from users and query which permissions they have.
      </p>
      <p>
        It is recommended that a UA shows some form of unobtrusive notification
        that informs the user when a wake lock is active, as well as provides
        the user with the means to <a href="#dfn-block-a-permission">block</a>
        the ongoing operation, or simply dismiss the notification.
      </p>
      <p>
        The <code>"wake-lock"</code> <a>powerful feature</a> is defined as follows:
      </p>
      <p>
        The <a>permission descriptor type</a> is the following
        <dfn data-lt="WakeLockPermissionDescriptor">dictionary</dfn>,
        which augments the <a>PermissionDescriptor</a> with a
        <dfn data-lt="WakeLockPermissionDescriptor.type">type</dfn> member,
        allowing for more fine-grained permissions.
      </p>
      <pre class="idl">
        dictionary WakeLockPermissionDescriptor : PermissionDescriptor {
          WakeLockType type;
        };
      </pre>
      <p>
        The <a>permission name</a> is defined as <code>"wake-lock"</code>.
      </p>
      <p>
        Within this section, |descriptor| is an instance of the
        <a>permission descriptor type</a> of the <code>"wake-lock"</code>
        <a>powerful feature</a>.
      </p>
      <p>
        To <dfn>block a permission</dfn>, run these steps:
      </p>
      <ol class="algorithm">
        <li>
          Let |descriptor| be the <a>permission descriptor type</a>
          instance to be blocked.
        </li>
        <li>
          Set |descriptor|'s <a>permission state</a> to "<a>denied</a>".
        </li>
        <li>
          Let |record| be the <a>platform wake lock</a>'s
          <a>state record</a> associated with |descriptor|'s
          <a data-lt="WakeLockPermissionDescriptor.type">type</a> member.
        </li>
        <li>
          <a data-cite="infra#list-iterate">for each</a> |lock|
          in |record|.<a>[[\InstanceList]]</a>:
          <ol>
            <li>
              Run <a>release a wake lock</a> on |lock|.
            </li>
          </ol>
        </li>
      </ol>
      <p>
        To <dfn>obtain permission</dfn> for <a>wake lock type</a>
        |type|, run these steps <a>in parallel</a>. This async algorithm
        returns either "<a>granted</a>" or "<a>denied</a>".
      </p>
      <ol class="algorithm">
        <li>
          Let |permissionDesc:PermissionDescriptor| be a newly created
          <a>PermissionDescriptor</a>.
        </li>
        <li>
          Set |permissionDesc|'s name to "<code>wake-lock</code>".
        </li>
        <li>
          Set |permissionDesc|'s type to |type|.
        </li>
        <li>
          Let |resultPromise| be the result of running
          <a>query a permission</a> with |permissionDesc|.
        </li>
        <li>
          Let |status:PermissionStatus| be the result of waiting for
          |resultPromise| to settle.
        </li>
        <li>
          If |resultPromise| rejects, return "<a>denied</a>".
        </li>
        <li>
          Let |state| be the value of the
          <a data-cite="permissions#dom-permissionstatus-state">state</a>
          attribute of |status|.
        </li>
        <li>
          If |state| is "<a>prompt</a>", run the following steps:
          <ol>
            <li>
              If these <a>obtain permission</a> steps were not
              <a>triggered by user activation</a>, return "<a>denied</a>".
            </li>
            <li>
              Return the result of <a>requesting permission
              to use</a> with |permissionDesc|.
            </li>
          </ol>
        </li>
        <li>
          Otherwise, return |state|.
        </li>
      </ol>
      <div class="note">
        In the case the steps are run from a dedicated worker, then the
        <a>global object</a> is a <a>DedicatedWorkerGlobalScope</a>,
        which  means that the <a>obtain permission</a> steps can never be
        <a>triggered by user activation</a>, meaning that in order to use
        wake locks from a dedicated worker, prior permission needs to
        granted from the <a>browsing context</a> who created it,
        e.g. the <a>browsing context</a> that is exists in the
        <a>DedicatedWorkerGlobalScope</a>'s <a>owner set</a>.
      </div>
    </section>

    <section data-dfn-for="WakeLockType">
      <h2>
        The <dfn>WakeLockType</dfn> enum
      </h2>
      <p>
        For the purpose of wake lock type description, this specification
        defines the following enumeration:
      </p>
      <pre class="idl">
        enum WakeLockType { "screen", "system" };
      </pre>
      <dl>
        <dt>
          <dfn>screen</dfn>
        </dt>
        <dd>
          <a>Screen wake lock</a> type.
        </dd>
        <dt>
          <dfn>system</dfn>
        </dt>
        <dd>
          <a>System wake lock</a> type.
        </dd>
      </dl>
    </section>
    <section><h3>Concepts and state record</h3>
      <p>
        The term <dfn>platform wake lock</dfn> refers to platform interfaces
        with which the user agent interacts to query state and acquire and
        release a wake lock.
      </p>
      <p>
        A <a>platform wake lock</a> can be defined by the underlying platform
        (e.g. in a native wake lock framework) or by the user agent, if it has
        direct hardware control.
      </p>
      <p>
        Each <a>platform wake lock</a> (one per <a>wake lock type</a>) has an
        associated <dfn>state record</dfn> with the following
        <a>internal slots</a>:
      </p>
      <table class="simple">
        <thead>
          <tr>
          <th>Internal slot</th>
          <th>Initial value</th>
          <th>Description (<em>non-normative</em>)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><dfn>[[\InstanceList]]</dfn></td>
            <td>
              The <a data-cite="infra#list-is-empty">empty</a>
              <a data-cite="infra#ordered-set">set</a>.
            </td>
            <td>
              A <a data-cite="INFRA#ordered-set">set</a>
              of <a>WakeLock</a> instances.
            </td>
          </tr>
          <tr>
          <td><dfn>[[\RequestCounter]]</dfn></td>
          <td>
            0.
          </td>
          <td>
            The value indicates the amount of current
            requests for the <a>wake lock type</a>.
            A number greater than zero indicates an
            <dfn>outstanding wake lock request</dfn>
          </td>
          </tr>
        </tbody>
      </table>
    </section>

    <section data-dfn-for="WakeLock" data-link-for="WakeLock">
      <h2>
        The <dfn>WakeLock</dfn> interface
      </h2>
      <p>
        The <a>WakeLock</a> interface allows the page to request wake locks of
        a particular type, to determine the current wake lock state and to
        receive notifications when the wake lock state is changed.
      </p>
      <pre class="idl">
        [Constructor(WakeLockType type), SecureContext, Exposed=(DedicatedWorker, Window)]
        interface WakeLock : EventTarget {
          [Exposed=Window] static Promise&lt;PermissionState&gt; requestPermission(WakeLockType type);
          readonly attribute WakeLockType type;
          readonly attribute boolean active;
          attribute EventHandler onactivechange;
          Promise&lt;void> request(optional WakeLockRequestOptions options);
        };
      </pre>
      <section>
        <h3>Constructor</h3>
        <p>
          To <dfn data-lt="create and initialize a wake lock object">create and
          initialize</dfn> a <a>WakeLock</a> object of type |type|, the
          following steps MUST be performed:
        </p>
        <ol class="algorithm">
          <li>
            Let |document| be the <a>responsible document</a> of the
            <a>current settings object</a>.
          </li>
          <li>
            If the <a>current global object</a> is the <a>DedicatedWorkerGlobalScope</a>
            object and its <a>owner set</a> is <a data-cite="infra#list-is-empty">empty</a>,
            throw a "<a>NotAllowedError</a>" <a>DOMException</a>.
          </li>
          <li>
            If the <a>current global object</a> is the <a>Window</a> object and
            the |document|'s <a>browsing context</a> is <code>null</code>,
            throw a "<a>NotAllowedError</a>" <a>DOMException</a>.
          </li>
          <li data-tests="wakelock-disabled-by-feature-policy.https.sub.html">
            If |document| is not <a>allowed to use</a> the
            <a>policy-controlled feature</a> named "<code>wake-lock</code>",
            throw a "<a>NotAllowedError</a>" <a>DOMException</a>.
          </li>
          <li>
            If the <a>user agent</a> <a data-lt="deny wake lock">denies the
            wake lock</a> of this |type| for |document|,
            throw a "<a>NotAllowedError</a>" <a>DOMException</a>.
          </li>
          <li data-tests="wakelock-api.https.html">
            Let |lock| be a new <a>WakeLock</a> object.
          </li>
          <li data-tests="wakelock-type.https.html">
            Set |lock|'s type to |type|.
          </li>
          <li>
            Let |record| be the <a>platform wake lock</a>'s
            <a>state record</a> associated with |type|.
          </li>
          <li>
            Add |lock| to |record|.<a>[[\InstanceList]]</a>.
          </li>
          <li data-tests="wakelock-onactivechange.https.html">
            If the wake lock of type |type| is currently <a data-lt=
            "acquire wake lock">acquired</a>, set |lock|'s
            <a href="#dom-wakelock-active">active</a>
            to <code>true</code>, otherwise to <code>false</code>.
          </li>
          <li>
            Return |lock|.
          </li>
        </ol>
      </section>
      <section data-dfn-for="WakeLock">
        <h3><dfn>requestPermission()</dfn> static method</h3>
        <p>
          The <a>requestPermission()</a> method, when invoked, MUST run the
          following steps. This algorithm resolves with either
          "<a>granted</a>" or "<a>denied</a>".
        </p>
        <ol class="algorithm">
          <li>
            Let |promise:Promise| be
            <a data-cite="promises-guide#a-new-promise">a new promise</a>.
          </li>
          <li>
            Let |type| be the first argument.
          </li>
          <li>
            Return |promise| and run the following steps <a>in parallel</a>:
            <ol>
              <li>
                Let |state| be the result of running and waiting for the
                <a>obtain permission</a> steps with |type|.
              </li>
              <li>
                Resolve |promise| with |state|.
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section data-dfn-for="WakeLock">
        <h3><dfn>type</dfn> attribute</h3>
        <p>
          When getting, the <a>type</a> attribute returns this <a>WakeLock</a>'s
          <a>wake lock type</a>.
        </p>
      </section>
      <section data-dfn-for="WakeLock">
        <h3><dfn>active</dfn> attribute</h3>
        <p>
          The <a>active</a> attribute represents whether a
          wake lock of <a>WakeLock</a>'s <a data-lt="wake lock type">type</a> is currently
          <a data-lt="acquire wake lock">acquired</a> by the <a>user agent</a>.
        </p>
      </section>
      <section data-dfn-for="WakeLock">
        <h3><dfn>onactivechange</dfn> attribute</h3>
        <p data-tests="wakelock-onactivechange.https.html">
          A <a>WakeLock</a>'s <a>onactivechange</a> attribute is an <a>EventHandler</a>
          with the corresponding <a>event handler event
          type</a> of <code>activechange</code>. Fired when current wake lock
          status indicated by the <a href="#dom-wakelock-active">active</a>
          attribute changes.
        </p>
      </section>
      <section> <h3>The <dfn>WakeLockRequestOptions</dfn> dictionary</h3>
        <pre class="idl">
          dictionary WakeLockRequestOptions {
            AbortSignal? signal;
          };
        </pre>
        <p>
          The <dfn>WakeLockRequestOptions.signal</dfn> property allows to abort
          any wake lock request.
        </p>
      </section>
      <section>
        <h3><dfn>request()</dfn> method</h3>
        <p data-tests="wakelock-api.https.html">
          The <a>request()</a> method, when invoked, MUST run the
           following steps:
        </p>
        <ol class="algorithm">
          <li>
            Let |options| be the first argument.
          </li>
          <li>
            Let |lock| be the <a>context object</a>.
          </li>
          <li>
            Let |record| be the <a>platform wake lock</a>'s
            <a>state record</a> associated with
            |lock|'s |type|.
          </li>
          <li>
            Let |promise:Promise| be
            <a data-cite="promises-guide#a-new-promise">a new promise</a>.
          </li>
          <li>
            Return |promise| and run the following steps <a>in parallel</a>:
            <ol>
              <li>
                Let |state| be the result of running and waiting for the
                <a>obtain permission</a> steps with |type|.
              </li>
              <li>
                If |state| is "<a>denied</a>", then reject |promise|
                with a "<a>NotAllowedError</a>" <a>DOMException</a>,
                and abort these steps.
              </li>
              <li>
                Let |signal| be the |options| dictionary member
                of the same name if present, or <code>null</code> otherwise.
              </li>
              <li>
                If |signal|’s <a>aborted flag</a> is set, then
                reject |promise| with an "<a>AbortError</a>"
                <a>DOMException</a>, and abort these steps.
              </li>
              <li>
                If |signal| is not <code>null</code>, then
                <a>add the following abort steps</a> to |signal|:
                <ol>
                  <li>
                    Decrease |record|.<a>[[\RequestCounter]]</a> by one.
                  </li>
                  <li>
                    If |record|.<a>[[\RequestCounter]]</a> is 0, then
                    run the following steps <a>in parallel</a>:
                    <ol>
                      <li>
                        Run <a>release a wake lock</a> on |lock|.
                      </li>
                    </ol>
                  </li>
                  <li>
                    Reject |promise| with an "<a>AbortError</a>"
                    <a>DOMException</a>, and abort these steps.
                  </li>
                </ol>
              </li>
              <li>
                If the <a>current global object</a> is not a <a>DedicatedWorkerGlobalScope</a>
                object, run the following steps:
                <ol>
                  <li>
                    Let |document| be the <a>responsible document</a> of the
                    <a>current settings object</a>.
                  </li>
                  <li>
                    If |document| is not <a>fully active</a>,
                    reject |promise| with a "<a>NotAllowedError</a>"
                    <a>DOMException</a>, and abort these steps.
                  </li>
                  <li>
                    If |lock|'s |type| is
                    "<a data-lt="WakeLockType.screen">screen</a>" and the
                    <a>Document</a> of the <a>top-level browsing context</a>
                    is <a>hidden</a>, reject |promise|
                    with a "<a>NotAllowedError</a>"
                    <a>DOMException</a>, and abort these steps.
                  </li>
                </ol>
              </li>
              <li>
                Increase |record|.<a>[[\RequestCounter]]</a> by one.
              </li>
              <li>
                If |record|.<a>[[\RequestCounter]]</a> is 1,
                run the following steps:
                <ol>
                  <li>
                    Let |success| be the the result of running and
                    waiting for <a>acquire a wake lock</a> on |lock|.
                  </li>
                  <li>
                    If |success| is <code>false</code> then reject
                    |promise| with a "<a>NotAllowedError</a>"
                    <a>DOMException</a>, and abort these steps.
                  </li>
                </ol>
              </li>
              <li>
                Resolve |promise| with <code>void</code>.
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <div class="note">
        The additional visibility requirement for screen wake lock is to
        prevent keeping the screen on when the page is not visible, such as
        when the browser is minimized. As this condition is transient and not
        under control of the web page, the specification chooses to
        automatically acquire and release the lock when visibility changes
        rather than having the page to deal with it, e.g by re-requesting the
        lock each time the page becomes visible again.
      </div>
    </section>
    <section>
      <h2>
        Managing Wake Locks
      </h2>
      <p data-tests=
      "wakelockrequest-is-independent.https.html, wakelock-promise.https.html">
        This section applies to each <a>wake lock type</a> equally and
        independently, unless a particular <a>wake lock type</a> is explicitly
        mentioned.
      </p>
      <p>
        The <a>user agent</a> <dfn data-lt="acquire wake lock">acquires the
        wake lock</dfn> by requesting the underlying operating system to apply
        the lock. The lock is considered acquired only when the request to the
        operating system succeeds.
      </p>
      <p>
        Conversely, the <a>user agent</a> <dfn data-lt=
        "release wake lock">releases the wake lock</dfn> by requesting the
        underlying operating system to no longer apply the wake lock. The lock
        is considered released only when the request to the operating system
        succeeds.
      </p>
      <p>
        The wake lock is <dfn data-lt="applicable wake lock">applicable</dfn>
        if the state of the operating system permits application of the lock
        (e.g. there is sufficient battery charge).
      </p>
      <p data-tests="wakelock-applicability-manual.https.html">
        The <a>screen wake lock</a> MUST NOT be <a data-lt=
        "applicable wake lock">applicable</a> after the screen is
        manually swiched off by the user until it is switched on again.
        Manually switching off the screen MUST NOT affect the <a data-lt=
        "applicable wake lock">applicability</a> of the <a>system wake
        lock</a>.
      </p>
      <div class="note">
        Whether the wake lock is applicable is a transient condition, e.g. when
        the battery charge is low but then the battery is recharged. So like
        the visibility requirement, this is part of automatic wake lock
        management and not part of the decision process whether to allow or
        deny the wake lock.
      </div>

      <section> <h3>Auto-releasing wake locks</h3>
      <p>
        A user agent may <a>release a wake lock</a> at any time it:
      </p>
      <ul>
        <li>
          Detects abnormal operation: such as infinite loops and tasks
          exceeding imposed time limits (if any).
        </li>
        <li>
          Battery is considered low and discharging.
        </li>
        <li>
          The user turns on some kind of device power conservation mode.
        </li>
      </ul>
      </section>

      <section> <h3>Handling document loss of full activity</h3>
        When the user agent determines that
        a <a>responsible document</a> of the <a>current settings object</a>
        is no longer <a>fully active</a>, it must run these steps:
        <ol class="algorithm">
          <li>
            Let |record| be the <a>platform wake lock</a>'s
            <a>state record</a> associated with <a>wake lock type</a>
            <code>"screen"</code> and <code>"system"</code>.
          </li>
          <li>
            <a data-cite="infra#list-iterate">for each</a> |lock|
            in |record|.<a>[[\InstanceList]]</a>:
            <ol>
              <li>
                Run <a>release a wake lock</a> on |lock|.
              </li>
            </ol>
          </li>
        </ol>
        <div class="note">
          Only documents presented to the user, thus with an associated
          <a>browsing context</a> can be <a>active documents</a>, so the
          above steps are only relevant for these.
        </div>
      </section>

      <section> <h3>Handling document loss of visibility</h3>
        When the user agent determines that the <a>visibility state</a> of
        the <a>Document</a> of the <a>top-level browsing context</a>
        changes, it must run these steps:
        <ol class="algorithm">
          <li>
            Let |document| be the <a>Document</a> of the
            <a>top-level browsing context</a>.
          </li>
          <li>
            If |document|'s <a>visibility state</a> is
            <code>"visible"</code>, abort these steps.
          </li>
          <li>
            Let |screenRecord| be the <a>platform wake lock</a>'s
            <a>state record</a> associated with <a>wake lock type</a>
            <code>"screen"</code>.
          </li>
          <li>
            <a data-cite="infra#list-iterate">for each</a> |lock|
            in |screenRecord|.<a>[[\InstanceList]]</a>:
            <ol>
              <li>
                Run <a>release a wake lock</a> on |lock|.
              </li>
            </ol>
          </li>
        </ol>
        <div class="note">
          As some locks like <code>"system"</code> are allowed to run while
          the <a>Document</a> of the <a>top-level browsing context</a>
          is not visible, it is encouraged
          that user agents show some UI indicating this.
        </div>
        <div class="note">
          The <a>visibility state</a> is only exposed on the <a>Window</a>
          object, thus the above steps are not relevant to wake locks
          running as part of a dedicated worker.
        </div>
      </section>

      <section> <h3>Acquire wake lock algorithm</h3>
        To <dfn>acquire a wake lock</dfn> for a given <a>WakeLock</a> object
        |lock|, run these steps <a>in parallel</a>:
        <ol class="algorithm">
          <li>
            Let |type| be |lock|'s <a href="#dom-wakelock-type">type</a>.
          </li>
          <li>
            If the wake lock for type |type| is not <a data-lt=
            "applicable wake lock">applicable</a>, return <code>false</code>.
          </li>
          <li>
            Ask the underlying operation system to
            <a data-lt="acquire wake lock">acquire the wake lock</a> of
            type |type| and let |success| be <code>true</code>
            if the operation succeeded, or else <code>false</code>.
          </li>
          <li data-tests="wakelock-onactivechange.https.html">
            If |success| is different from |lock|'s
            <a href="#dom-wakelock-active">active</a>, set
            |lock|'s <a href="#dom-wakelock-active">active</a>
            to |success|
            and <a>fire an event</a> named
            <code>"activechange"</code> at |lock|.
          </li>
          <li>
            Return |success|.
          </li>
        </ol>
      </section>

      <section> <h3>Release wake lock algorithm</h3>
        To <dfn>release a wake lock</dfn> for a given <a>WakeLock</a> object
        |lock|, run these steps <a>in parallel</a>:
        <ol class="algorithm">
          <li>
            Let |type| be |lock|'s <a href="#dom-wakelock-type">type</a>.
          </li>
          <li>
            Ask the underlying operation system to
            <a data-lt="release wake lock">release the wake lock</a> of
            type |type| and let |success| be <code>true</code>
            if the operation succeeded, or else <code>false</code>.
          </li>
          <li data-tests="wakelock-onactivechange.https.html">
            If |success| is different from |lock|'s
            <a href="#dom-wakelock-active">active</a>, set |lock|'s
            <a href="#dom-wakelock-active">active</a> to the negated |success|
            and <a data-lt="fire an event">fire an event</a> named
            <code>"activechange"</code> at |lock|.
          </li>
          <li>
            If |lock|'s type is <code>"screen"</code> run the following:
            <ol>
              <li>
                The <a>user agent</a> MUST reset the platform-specific inactivity
                timer after which the screen is actually turned off.
              </li>
            </ol>
          </li>
          <li>
            Return |success|.
          </li>
        </ol>
        <div class="note">
          Resetting the inactivity timer prevents the screen from going blank
          immediately after the wake lock is released.
        </div>
      </section>
    </section>
    <section>
      <h2>
        Security and privacy considerations
      </h2>
      <p>
        Application of a wake lock causes various device components such as
        display or CPU to operate at higher power levels than they otherwise
        would. This can lead to undesirable and potentially dangerous effects
        such as excessive heating and faster than normal battery charge
        depletion. The latter is particularly relevant to mobile devices which
        may not have a stationary power source readily available. Complete
        battery depletion at an unexpected time can lead to inability of the
        user to make or receive calls and use network services, including the
        emergency call service. Implementations should consider preventing wake
        lock application if they determine that the remaining battery capacity
        is low.
      </p>
      <p data-tests="wakelock-state-is-global.https.html">
        The ability to observe the global state of a wake lock can create a
        communication channel between two otherwise isolated <a data-lt=
        "document">documents</a>. One document can request wake lock which
        changes the global wake lock state, and another document can observe
        this change by subscribing to events in <a>WakeLock</a>.
      </p>
      <p>
        When the <a>user agent</a> does not <a>acquire wake lock</a> even
        though a browsing context has requested it, this can be observed by the
        browsing context and can possibly disclose sensitive information about
        the state of the device such as that battery level is low.
      </p>
    </section>
    <section id="examples" class="informative">
      <h2>
        Examples
      </h2>
      <p>
        This example acquires a screen wake lock and releases it after a while:
      </p>
      <pre class="example">
        async function tryKeepScreenAlive(minutes) {
          const lock = new WakeLock("screen");

          const controller = new AbortController();
          const signal = controller.signal;

          lock.request({ signal });

          setTimeout(() => controller.abort(), minutes * 60 * 1000);
        }

        tryKeepScreenAlive(10);
      </pre>
      <p>
        This example requests a screen wake lock and listens to wake lock state
        changes:
      </p>
      <pre class="example">
        const controller = new AbortController();
        const signal = controller.signal;

        const checkbox = document.createElement("input");
        checkbox.setAttribute("type", "checkbox");
        document.body.appendChild(checkbox);

        const lock = new WakeLock("screen");
        lock.onactivechange = () => {
          checkbox.checked = lock.active;
        };
        lock.request({ signal });

        setTimeout(() => controller.abort(), 5 * 1000);
      </pre>
      <p>
        In this example, two screen wake lock requests are created and
        cancelled independently:
      </p>
      <pre class="example">
        const controller = new AbortController();
        const signal = controller.signal;

        const lock1 = new WakeLock("screen");
        const lock2 = new WakeLock("screen");

        lock1.request({ signal }));

        // ...somewhere else

        lock2.request({ signal }));

        // ...somewhere else

        controller.abort();
      </pre>
    </section>
    <section>
      <h2>
        Dependencies
      </h2>
      <p>
        <dfn data-cite="HTML#document"><code>Document</code></dfn>,
        <dfn data-cite="HTML#window">Window</dfn>,
        <dfn data-cite="HTML#dedicatedworkerglobalscope">DedicatedWorkerGlobalScope</dfn>,
        <dfn data-cite="HTML#active-document">active document</dfn>,
        <dfn data-cite="HTML#global-object">global object</dfn>,
        <dfn data-cite="HTML#browsing-context">browsing context</dfn>,
        <dfn data-cite="HTML/webappapis.html#eventhandler"><code>EventHandler</code></dfn>
        are defined in [[HTML]].
      </p>
      <p>
        <dfn data-cite="DOM#abortsignal-add">add the following abort steps</dfn>
        is defined in [[DOM]].
      </p>
      <p>
        <dfn data-cite="WEBIDL#aborterror"><code>AbortError</code></dfn>,
        <dfn data-cite="WEBIDL#notsupportederror"><code>NotSupportedError</code></dfn>,
        <dfn data-cite="WEBIDL#notallowederror"><code>NotAllowedError</code></dfn>,
        <dfn data-cite="WEBIDL#dfn-DOMException"><code>DOMException</code></dfn>
        are defined in [[WEBIDL]].
      </p>
      <p>
        The terms <dfn data-cite="PERMISSIONS#query-a-permission">query a permission</dfn>,
        <dfn data-cite="PERMISSIONS#request-permission-to-use">requesting permission to use</dfn>,
        <dfn data-cite="PERMISSIONS#permission-revocation-algorithm">revocable</dfn>,
        <dfn data-cite="PERMISSIONS#permission-descriptor-type">permission descriptor type</dfn>,
        <dfn data-cite="PERMISSIONS#dom-permissiondescriptor-name">permission name</dfn>,
        <dfn data-cite="PERMISSIONS#permission-state">permission state</dfn>,
        <dfn data-cite="PERMISSIONS#powerful-feature">powerful feature</dfn>,
        <dfn data-cite="PERMISSIONS#dom-permissionstate-denied"><code>denied</code></dfn>,
        <dfn data-cite="PERMISSIONS#dom-permissionstate-granted"><code>granted</code></dfn>,
        <dfn data-cite="PERMISSIONS#dom-permissionstate-prompt"><code>prompt</code></dfn> and
        <dfn data-cite="PERMISSIONS#dictdef-permissiondescriptor">PermissionDescriptor</dfn>
        are defined in [[PERMISSIONS]].
      </p>
      <p>
        <dfn data-cite="ECMASCRIPT#sec-promise-objects"><code>Promise</code></dfn> and
        <dfn data-cite="ECMASCRIPT#sec-object-internal-methods-and-internal-slots">internal slots</dfn>
        are defined in [[ECMASCRIPT]].
      </p>
      <p>
        Document's <dfn data-cite="PAGE-VISIBILITY#dom-document-hidden">hidden</dfn> attribute, and
        <dfn data-cite="PAGE-VISIBILITY#dfn-visibility-states">visibility state</dfn>
        are defined in [[PAGE-VISIBILITY]].
      </p>
    </section>
    <section class="informative">
      <h2>
        Use cases
      </h2>
      <p>
        The use cases and requirements are documented in
        [[WAKE-LOCK-USE-CASES]].
      </p>
    </section>
    <section id="conformance">
      <p>
        This specification defines conformance criteria for a single product: a
        <dfn>user agent</dfn> that implements the interfaces that it contains.
      </p>
      <p>
        The <a>user agent</a> MUST implement the APIs defined in this
        specification in a manner that conforms to the <a href=
        "https://heycam.github.io/webidl/#ecmascript-binding">ECMAScript
        Bindings</a> defined in [[WEBIDL]].
      </p>
    </section>
    <section id="idl-index" class="appendix"></section>
    <section class="appendix informative" id="acknowledgments">
      <h2>
        Acknowledgments
      </h2>
      <p>
        We would like to offer our sincere thanks to Mounir Lamouri, Sergey
        Konstantinov, Matvey Larionov, Dominique Hazael-Massieux, Domenic Denicola,
        Thomas Steiner for their contributions to this work.
      </p>
    </section>
  </body>
</html>
